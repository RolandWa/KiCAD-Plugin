name: Validate Repository

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'packages/**'
      - 'kicad-repository.json'
      - '.github/workflows/validate.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install jsonschema requests

      - name: Validate JSON syntax
        run: |
          echo "Validating JSON files..."
          python << 'EOF'
          import json
          import sys
          import os
          
          files_to_check = [
              'kicad-repository.json',
              'packages.json'
          ]
          
          # Find all metadata.json files in packages/ directory
          packages_dir = 'packages'
          if os.path.exists(packages_dir):
              for plugin_dir in os.listdir(packages_dir):
                  metadata_path = os.path.join(packages_dir, plugin_dir, 'metadata.json')
                  if os.path.exists(metadata_path):
                      files_to_check.append(metadata_path)
          
          errors = []
          for file_path in files_to_check:
              try:
                  with open(file_path, 'r') as f:
                      json.load(f)
                  print(f"✅ {file_path}: Valid JSON")
              except json.JSONDecodeError as e:
                  errors.append(f"❌ {file_path}: {str(e)}")
                  print(f"❌ {file_path}: {str(e)}")
              except FileNotFoundError:
                  print(f"⚠️  {file_path}: File not found")
          
          if errors:
              sys.exit(1)
          EOF

      - name: Validate repository structure
        run: |
          echo "Checking repository structure..."
          python << 'EOF'
          import os
          import sys
          import json
          
          required_files = {
              'kicad-repository.json': 'Main repository index',
              'packages.json': 'Packages list',
              'README.md': 'Repository documentation'
          }
          
          errors = []
          warnings = []
          
          for file_path, description in required_files.items():
              if os.path.exists(file_path):
                  print(f"✅ {description}: {file_path}")
              else:
                  errors.append(f"❌ Missing required file: {file_path} ({description})")
                  print(f"❌ Missing required file: {file_path} ({description})")
          
          # Check package structure for plugins in packages.json
          with open('packages.json', 'r') as f:
              packages_data = json.load(f)
          
          for package in packages_data.get('packages', []):
              identifier = package.get('identifier', '')
              # Extract plugin folder name from identifier (e.g., com.rolandwa.emc-auditor -> emc_auditor)
              # Note: This is a simplification; real folder names may vary
              plugin_name = package.get('name', 'Unknown')
              
              # Check if we can find the package directory
              packages_dir = 'packages'
              found = False
              if os.path.exists(packages_dir):
                  for plugin_dir in os.listdir(packages_dir):
                      metadata_path = os.path.join(packages_dir, plugin_dir, 'metadata.json')
                      if os.path.exists(metadata_path):
                          with open(metadata_path, 'r') as mf:
                              meta = json.load(mf)
                              if meta.get('identifier') == identifier:
                                  print(f"✅ {plugin_name} package directory: packages/{plugin_dir}")
                                  found = True
                                  
                                  # Check for recommended files
                                  icon_path = os.path.join(packages_dir, plugin_dir, 'icon.png')
                                  readme_path = os.path.join(packages_dir, plugin_dir, 'README.md')
                                  
                                  if os.path.exists(icon_path):
                                      print(f"  ✅ Icon: {icon_path}")
                                  else:
                                      warnings.append(f"⚠️  {plugin_name} missing icon: {icon_path}")
                                      print(f"  ⚠️  Missing icon: {icon_path}")
                                  
                                  if os.path.exists(readme_path):
                                      print(f"  ✅ README: {readme_path}")
                                  else:
                                      warnings.append(f"⚠️  {plugin_name} missing README: {readme_path}")
                                      print(f"  ⚠️  Missing README: {readme_path}")
                                  break
              
              if not found:
                  errors.append(f"❌ Package directory not found for {plugin_name} (identifier: {identifier})")
                  print(f"❌ Package directory not found for {plugin_name} (identifier: {identifier})")
          
          if warnings:
              print("\nWarnings found (non-blocking):")
              for warning in warnings:
                  print(warning)
          
          if errors:
              sys.exit(1)
          EOF

      - name: Validate metadata schema
        run: |
          echo "Validating metadata against KiCAD PCM schema..."
          python << 'EOF'
          import json
          import sys
          import os
          
          def validate_metadata(metadata, plugin_name):
              required_fields = [
                  'name', 'description', 'description_full', 'identifier',
                  'type', 'author', 'license', 'resources', 'versions'
              ]
              
              errors = []
              warnings = []
              
              # Check required fields
              for field in required_fields:
                  if field not in metadata:
                      errors.append(f"Missing required field: {field}")
              
              # Validate versions array
              if 'versions' in metadata and len(metadata['versions']) > 0:
                  version = metadata['versions'][0]
                  version_fields = [
                      'version', 'status', 'kicad_version',
                      'download_sha256', 'download_size', 'download_url'
                  ]
                  
                  for field in version_fields:
                      if field not in version:
                          errors.append(f"Missing version field: {field}")
                      elif field == 'download_sha256' and version[field] == '':
                          warnings.append(f"Empty download_sha256 (expected before build)")
                      elif field == 'download_size' and version[field] == 0:
                          warnings.append(f"Zero download_size (expected before build)")
              else:
                  errors.append("No versions defined in metadata")
              
              # Report results
              print(f"\n{plugin_name} Validation:")
              if errors:
                  print(f"❌ Errors found:")
                  for error in errors:
                      print(f"   - {error}")
              if warnings:
                  print(f"⚠️  Warnings:")
                  for warning in warnings:
                      print(f"   - {warning}")
              if not errors and not warnings:
                  print(f"✅ All checks passed")
              
              return len(errors) == 0
          
          # Read packages.json to get list of active plugins
          with open('packages.json', 'r') as f:
              packages_data = json.load(f)
          
          # Validate only plugins that are in packages.json
          all_ok = True
          if packages_data.get('packages'):
              print(f"Found {len(packages_data['packages'])} plugin(s) in packages.json")
              for package in packages_data['packages']:
                  ok = validate_metadata(package, package.get('name', 'Unknown'))
                  all_ok = all_ok and ok
          else:
              print("⚠️  No packages found in packages.json")
          
          if not all_ok:
              sys.exit(1)
          EOF

      - name: Check URLs accessibility
        run: |
          echo "Checking URL accessibility..."
          python << 'EOF'
          import json
          import requests
          import sys
          
          def check_url(url, description):
              try:
                  response = requests.head(url, timeout=10, allow_redirects=True)
                  if response.status_code < 400:
                      print(f"✅ {description}: {url} (Status: {response.status_code})")
                      return True
                  else:
                      print(f"❌ {description}: {url} (Status: {response.status_code})")
                      return False
              except requests.RequestException as e:
                  print(f"⚠️  {description}: {url} (Error: {str(e)})")
                  return True  # Don't fail on network errors, just warn
          
          # Check packages.json URLs
          with open('packages.json', 'r') as f:
              packages_data = json.load(f)
          
          all_ok = True
          
          for package in packages_data.get('packages', []):
              if 'resources' in package and 'homepage' in package['resources']:
                  homepage = package['resources']['homepage']
                  check_url(homepage, f"{package['name']} homepage")
              
              # Note: Download URLs won't exist until after build
              # We just validate the JSON structure, not actual file existence
          
          print("\nNote: Download URLs will be validated after plugin packages are built")
          EOF

      - name: Summary
        run: |
          echo "## Validation Complete! ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All JSON files are valid and repository structure is correct." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python << 'EOF'
          import json
          
          # Read packages.json
          with open('packages.json', 'r') as f:
              packages_data = json.load(f)
          
          print("### Validated Plugins:", flush=True)
          if packages_data.get('packages'):
              for package in packages_data['packages']:
                  name = package.get('name', 'Unknown')
                  version = 'Not specified'
                  if package.get('versions') and len(package['versions']) > 0:
                      version = package['versions'][0].get('version', 'Unknown')
                  print(f"- {name} v{version}", flush=True)
          else:
              print("- No plugins currently in repository", flush=True)
          EOF
